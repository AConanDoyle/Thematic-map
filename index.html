<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
	<meta name="mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-capable" content="yes">

	<link rel="stylesheet" href="http://unpkg.com/leaflet@1.5.1/dist/leaflet.css">
	<link rel='stylesheet'
		href='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/leaflet.fullscreen.css'>
	<link rel="stylesheet" href="css/L.Control.Sidebar.css">
	<link rel="stylesheet" href="css/L.Control.HtmlLegend.css" />

	<script src="http://unpkg.com/leaflet@1.3.1/dist/leaflet.js"></script>
	<script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/Leaflet.fullscreen.min.js'></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-hash/0.2.1/leaflet-hash.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/leaflet.minichart@0.2.5/dist/leaflet.minichart.min.js"></script>

	<script src="js/L.Control.Sidebar.js"></script>
	<script src="js/L.Control.HtmlLegend.js"></script>


	<style>
		html,
		body,
		#map {
			width: 100%;
			height: 100%;
			padding: 0;
			margin: 0;
		}

		.infoBox {
			padding: 6px 8px;
			font: 14px/16px Arial, Helvetica, sans-serif;
			background: white;
			background: rgba(255, 255, 255, 0.8);
			box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
			border-radius: 5px;
		}

		.infoBox h4 {
			margin: 0 0 5px;
			color: #777;
		}
	</style>
	<title>Kolibri - project results</title>
</head>

<body>
	<div id="map">
	</div>
	<div id="sidebar">
		<h1>Kolibri - project results</h1>
		<h2>Social Media</h2>
		<h2>experince with catastroph</h2>
		<h2>infoTyp</h2>
		<h2>participationTyps</h2>
	</div>

	<script src="data/kolibri_sm_cat.geojson"></script>
	<script src="data/kolibri_parti_info.geojson"></script>

	<script>

		var hash = new L.Hash(map);
		var access_token = 'access_token=pk.eyJ1IjoiZmVvcyIsImEiOiJjandoa3E1ODQyN2NwNDhtcThna2RpbzdwIn0.1Igm1-YZfJKfGRVWzm2CkA';
		var basemap = L.tileLayer('https://api.mapbox.com/styles/v1/feos/cjxaf1go60e461cp3rmlsf7jm/tiles/256/{z}/{x}/{y}?' + access_token)

		var map = L.map('map', {
			zoomControl: true,
			maxZoom: 19,
			layers: [basemap]

		}).fitBounds([[7.0, -136.0], [74.0, 47.0]]);

		// fullscrenn control
		map.addControl(new L.Control.Fullscreen({
			title: {
				'false': 'View fullscreen',
				'true': 'Exit fullscreen'
			}
		}));

		// infoBox for mouseover
		var infoBox = L.control();
		infoBox.onAdd = function (map) {
			this._div = L.DomUtil.create('div', 'infoBox');
			this.update();
			return this._div;
		};

		// method that we will use to update the control based on feature properties passed
		infoBox.update = function (props) {
			this._div.innerHTML = '<h4>Likely social media use</h4>' + (props ?
				'<b>' + layer.feature.properties.NAME_0 + '</b> <br />' + props.density + '%'
				: 'Hover over a state');
		};
		infoBox.addTo(map);

		var colorSelectorSM = function (i) {
			switch (true) {
				case (i !== "no data" && i <= 1.5):
					return "#d5efcfff";
					break;
				case (i > 1.5 && i <= 2.0):
					return "#9ed898ff"
					break;
				case (i > 2.0 && i <= 2.5):
					return "#54b567ff"
					break;
				case (i > 2.5 && i <= 3.0):
					return "#1d8641ff"
					break;
				case (i > 3.0):
					return "#00441bff"
					break;
				default:
					return "grey";
			}
		};

		var colorSelectorExpCat = function (e) {
			switch (true) {
				case (e >= 0.0 && e <= 20.0):
					return "#fef0d9ff";
					break;
				case (e > 20.0 && e <= 40.0):
					return "#fdcc8aff"
					break;
				case (e > 40.0 && e <= 60.0):
					return "#fc8d59ff"
					break;
				case (e > 60.0 && e <= 80.0):
					return "#e34a33ff"
					break;
				case (e > 80.0 && e <= 100.0):
					return "#b30000ff"
					break;
				default:
					return "black";
			}
		};

		// creat sidebar
		var sidebar = L.control.sidebar('sidebar', {
			closeButton: "true",
			position: "left"
		});
		map.addControl(sidebar);

		// sidebar controle
		var sidebarControl = L.Control.extend({
			options: {
				position: 'topleft'
			},
			onAdd: function (map) {
				var container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
				container.style.backgroundColor = 'white';
				container.style.backgroundImage = 'url(images/info.png)';
				container.style.backgroundSize = "26px 26px";
				container.style.width = '30px';
				container.style.height = '30px';
				container.style.backgroundPosition = "center center";
				container.style.cursor = "pointer";
				container.title = 'View explanatory notes';
				container.onclick = function () {
					sidebar.toggle();
				}
				return container;
			}
		});
		map.addControl(new sidebarControl());

		// add dataset Social Media
		var layer_SM = new L.geoJson(kolibri_sm_cat, {
			style: styleSM,
			onEachFeature: onEachFeature
		})
			.bindTooltip(function (layer) {
				if (layer.feature.properties.index_usages_sm !== null) {
					var value = layer.feature.properties.index_usages_sm.toFixed(1);
				}
				else {
					var value = "no data";
				}
				return "Country: " + layer.feature.properties.NAME_0 +
					"<br /> Administrative divisions: " + layer.feature.properties.NAME_1 +
					"<br /> Likely social media use: " + value;
			}, { direction: "top", opacity: 0.7 }).addTo(map);

		function styleSM(feature) {
			if (feature.properties.index_usages_sm === null)
				var value = "no data"
			else
				var value = feature.properties.index_usages_sm;
			return {
				color: colorSelectorSM(value),
				weight: 1,
				dashArray: '5',
				fillOpacity: 0.5
			};
		}

		// add dataset experince with catastroph
		var layer_exp_cat = new L.geoJson(kolibri_sm_cat, {
			style: function c(feature) {
				return {
					color: colorSelectorExpCat(feature.properties.exp_cat_5years_Yes),
					weight: 1,
					dashArray: '5',
					fillOpacity: 0.5
				};
			}
		})
			.bindTooltip(function (layer) {
				if (layer.feature.properties.exp_cat_5years_Yes !== null) {
					var value = Math.round(layer.feature.properties.index_usages_sm) + "%";
				}
				else {
					var value = "no data";
				}
				return "Country: " + layer.feature.properties.NAME_0 +
					"<br /> Administrative divisions: " + layer.feature.properties.NAME_1 +
					"<br /> Experience with disaster events (last 5 years): " + value;
			}, { direction: "top", opacity: 0.7 });

		// add dataset infoTyp
		var layer_infoTyp = new L.FeatureGroup();
		for (const i in kolibri_parti_info.features) {
			var layer_infoTyp_single = L.minichart(
				// center chart
				[kolibri_parti_info.features[i].properties.centerlat,
				kolibri_parti_info.features[i].properties.centerlong],
				{
					data: [parseInt(kolibri_parti_info.features[i].properties.infoTyp_established),
					parseInt(kolibri_parti_info.features[i].properties.infoTyp_uninformed),
					parseInt(kolibri_parti_info.features[i].properties.infoTyp_special)],

					// format chart
					type: "pie", /* labels: [kolibri_parti_info.features[i].properties.infoTyp_established, 
					kolibri_parti_info.features[i].properties.infoTyp_uninformed,
					kolibri_parti_info.features[i].properties.infoTyp_special], */
					labelMinSize: 8, width: 80,
					colors: ["#7A8B99", "#91ADC2", "#A9DDD6"],
					transitionTime: 2500
				});

			layer_infoTyp_single.bindTooltip(function (layer) {
				return "Country: " + kolibri_parti_info.features[i].properties.NAME_0.toString() +
					"<br /> Established: " + kolibri_parti_info.features[i].properties.infoTyp_established.toString()
					+ "% <br /> Uninformed: " + kolibri_parti_info.features[i].properties.infoTyp_uninformed.toString() +
					"% <br /> Special: " + kolibri_parti_info.features[i].properties.infoTyp_special.toString() + "%";
			}, { direction: "top", opacity: 0.7 });
			layer_infoTyp.addLayer(layer_infoTyp_single);
		};

		// add dataset participationTyps
		var layer_parti = new L.FeatureGroup();
		for (const i in kolibri_parti_info.features) {
			var layer_parti_single = L.minichart(
				// center chart
				[kolibri_parti_info.features[i].properties.centerlat,
				kolibri_parti_info.features[i].properties.centerlong],
				{
					data: [parseInt(kolibri_parti_info.features[i].properties.partiTyp_inactive),
					parseInt(kolibri_parti_info.features[i].properties.partiTyp_altru),
					parseInt(kolibri_parti_info.features[i].properties.partiTyp_extro)],

					// format chart
					type: "pie", /* labels: [kolibri_parti_info.features[i].properties.partiTyp_inactive, 
					kolibri_parti_info.features[i].properties.partiTyp_altru,
					kolibri_parti_info.features[i].properties.partiTyp_extro], */
					labelMinSize: 8, width: 80,
					colors: ["#7A8B99", "#91ADC2", "#A9DDD6"],
					transitionTime: 2500
				});

			layer_parti_single.bindTooltip(function (layer) {
				return "Country: " + kolibri_parti_info.features[i].properties.NAME_0.toString() +
					"<br /> The Inactive: " + kolibri_parti_info.features[i].properties.partiTyp_inactive.toString()
					+ "% <br /> The Altruists: " + kolibri_parti_info.features[i].properties.partiTyp_altru.toString() +
					"% <br /> The Extroverts: " + kolibri_parti_info.features[i].properties.partiTyp_extro.toString() + "%";
			}, { direction: "top", opacity: 0.7 });
			layer_parti.addLayer(layer_parti_single);
		};

		function zoomToFeature(e) {
			map.fitBounds(e.target.getBounds());
		}

		function onEachFeature(feature, layer) {
			layer.on({
				mouseover: highlightFeature,
				// mouseout: resetHighlight,
				click: zoomToFeature
			});
		}

		function resetHighlight(e) {
			layer_SM.resetStyle(e.target);
		}

		function highlightFeature(e) {
			var layer = e.target;

			layer.setStyle({
				weight: 5,
				dashArray: '',
			});

			if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
				layer.bringToFront();
			}
		}


		// layer controle
		L.control.layers(
			{
				"Likely social media use": layer_SM,
				"Experience with disaster events (last 5 years)": layer_exp_cat,
				"Type of information": layer_infoTyp,
				"Types of participation": layer_parti
			}, null, { collapsed: true }).addTo(map);

		var legendSM = L.control.htmllegend({
			position: 'bottomright',
			legends: [{
				name: 'Likely social media use',
				layer: layer_SM,
				elements: [{
					label: '< 1,5',
					html: '',
					style: {
						'background-color': '#d5efcfff',
						'width': '15px',
						'height': '15px'
					}
				}, {
					label: '1,5 - 2,0',
					html: '',
					style: {
						'background-color': '#9ed898ff',
						'width': '15px',
						'height': '15px'
					}
				}, {
					label: '2,0 - 2,5',
					html: '',
					style: {
						'background-color': '#54b567ff',
						'width': '15px',
						'height': '15px'
					}
				}, {
					label: '2,5 - 3,0',
					html: '',
					style: {
						'background-color': '#1d8641ff',
						'width': '15px',
						'height': '15px'
					}
				}, {
					label: '> 3,0',
					html: '',
					style: {
						'background-color': '#00441bff',
						'width': '15px',
						'height': '15px'
					}
				}, {
					label: 'no data',
					html: '',
					style: {
						'background-color': 'grey',
						'width': '15px',
						'height': '15px'
					}
				}]
			}],
			collapseSimple: false,
			disableVisibilityControls: true
		})
		map.addControl(legendSM)

	</script>
</body>

</html>